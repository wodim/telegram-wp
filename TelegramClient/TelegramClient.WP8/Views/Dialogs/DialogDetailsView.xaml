<views:TelegramViewBase
    x:Class="TelegramClient.Views.Dialogs.DialogDetailsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:phone="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone"
    xmlns:shell="clr-namespace:Microsoft.Phone.Shell;assembly=Microsoft.Phone"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:templateSelectors="clr-namespace:TelegramClient.Helpers.TemplateSelectors"
    xmlns:controls="clr-namespace:Telegram.Controls;assembly=Telegram.Controls"
    xmlns:micro="clr-namespace:Caliburn.Micro;assembly=Caliburn.Micro"
    xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
    xmlns:toolkit="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone.Controls.Toolkit"
    xmlns:behaviors="clr-namespace:TelegramClient.Behaviors"
    xmlns:telegramClient="clr-namespace:TelegramClient"
    xmlns:telegramControls="clr-namespace:TelegramClient.Views.Controls"
    xmlns:views="clr-namespace:TelegramClient.Views"
    xmlns:emojiPanel="clr-namespace:Telegram.EmojiPanel"
    xmlns:controls1="clr-namespace:TelegramClient.Controls"
    xmlns:dialogs="clr-namespace:TelegramClient.Views.Dialogs"
    xmlns:profiling="clr-namespace:Telegram.Controls.Profiling;assembly=Telegram.Controls"
    FontFamily="{StaticResource PhoneFontFamilyNormal}"
    FontSize="{StaticResource PhoneFontSizeNormal}"
    Foreground="{StaticResource PhoneForegroundBrush}"
    SupportedOrientations="Portrait" Orientation="Portrait"
    x:Name="Self"
    CacheMode="BitmapCache"
    mc:Ignorable="d"
    UseLayoutRounding="True"
    Background="Transparent"
    BackKeyPress="DialogDetailsView_OnBackKeyPress"
    shell:SystemTray.Opacity="0.0"
    shell:SystemTray.IsVisible="True" d:DesignHeight="768" d:DesignWidth="480">

    <shell:SystemTray.ProgressIndicator>
        <shell:ProgressIndicator x:Name="ProgressIndicator" IsIndeterminate="{Binding IsWorking}" IsVisible="True" Text="{Binding MTProtoService.Message}"/>
    </shell:SystemTray.ProgressIndicator>

    <controls1:TelegramTransitionService.NavigationOutTransition>
        <controls1:TelegramNavigationOutTransition x:Name="OutTransition">
            <controls1:TelegramNavigationOutTransition.Forward>
                <controls1:TelegramTurnstileTransition Mode="ForwardOut"/>
            </controls1:TelegramNavigationOutTransition.Forward>
        </controls1:TelegramNavigationOutTransition>
    </controls1:TelegramTransitionService.NavigationOutTransition>

    <views:TelegramViewBase.Resources>
        <DataTemplate x:Key="UserMessageTemplate">
            <Grid x:Name="MainItemGrid2" Opacity="1" Loaded="MainItemGrid2_OnLoaded">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu Opened="ContextMenu_OnOpened" IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}">
                        <toolkit:MenuItem Loaded="ReplyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="DeleteMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="ForwardMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="CopyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action CopyMessage($DataContext)]" Header="{Binding Resources.Copy, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action SaveMedia($DataContext)]" Header="{Binding Resources.Save, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" 
                                          Visibility="{Binding Self, Converter={StaticResource MediaFileAvailableToVisibilityConverter}}"/>                       
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>

                <Grid x:Name="MainItemGrid" >
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Column="2" Grid.Row="0" Margin="0,12,24,0" Background="{Binding Converter={StaticResource OverlayAccentBrush}}">
                        <ContentControl
                            Background="Transparent" 
                            micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                            Width="{Binding ReplyWidth}"
                            Content="{Binding ReplyInfo.Reply}" 
                            Margin="12,8,12,6"
                            ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                            HorizontalContentAlignment="Stretch"
                            Visibility="{Binding ReplyVisibility}"
                            HorizontalAlignment="Stretch"/>
                        <Grid
                            Background="Transparent" 
                            micro:Message.Attach="[Event Tap] = [Action OpenFwdContactDetails($DataContext)]" 
                            Visibility="{Binding FwdFromPeerVisibility, FallbackValue=Collapsed}">
                            <Grid Margin="0,6,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.ColumnSpan="2" Text="{Binding Resources.ForwardedMessage, Source={StaticResource Strings}}" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Resources.From, Source={StaticResource Strings}, StringFormat='\{0\} '}" Margin="12,-3,0,0" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding FwdFrom.FullName}" Margin="0,-3,0,0" MaxHeight="24.83" HorizontalAlignment="Left" TextTrimming="WordEllipsis" MaxWidth="260" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                            </Grid>
                        </Grid>
                        <Grid Canvas.ZIndex="2">
                            <emojiPanel:TelegramRichTextBox
                                x:Name="Text"
                                Width="335"
                                MaxHeight="1500"
                                Visibility="{Binding Media, Converter={StaticResource GeoLocationToVisibilityConverter}}"
                                Text="{Binding Message}"
                                HorizontalAlignment="Stretch"
                                Background="{Binding Converter={StaticResource OverlayAccentBrush}}"
                                TextScaleFactor="{Binding TextScaleFactor, Source={StaticResource ScaledText}}"
                                FontSize="{Binding DefaultFontSize, Source={StaticResource ScaledText}}"
                                MoreElement="{Binding ElementName=MorePanel}"
                                Style="{StaticResource MessageBodyTelegramRichTextStyle}"/>
                            <Border x:Name="MorePanel" Background="{Binding Converter={StaticResource OverlayAccentBrush}}" VerticalAlignment="Bottom" Canvas.ZIndex="3" Visibility="Collapsed" Tap="MorePanel_OnTap">                           
                                <TextBlock Canvas.ZIndex="4"
                                    Text="{Binding Resources.More, Source={StaticResource Strings}, StringFormat='\{0\}...'}" 
                                    TextDecorations="Underline" 
                                    Margin="12,0,12,0" Foreground="#FFFFFFFF"
                                    FontFamily="{StaticResource PhoneFontFamilyNormal}" 
                                    FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                    VerticalAlignment="Bottom" HorizontalAlignment="Right"/>
                            </Border>
                        </Grid>
                        <ContentControl
                            MaxHeight="1500"
                            Background="Transparent"
                            micro:Message.Attach="[Event Tap] = [Action OpenMedia($DataContext)]"
                            Margin="12,6,12,0"
                            HorizontalContentAlignment="Stretch"
                            HorizontalAlignment="Stretch"
                            Content="{Binding Media}"
                            ContentTemplate="{Binding Media, Converter={StaticResource MediaTemplateSelector}}"/>
                        <Border 
                            Canvas.ZIndex="1" 
                            Background="{Binding Converter={StaticResource OverlayAccentBrush}}" 
                            HorizontalAlignment="Stretch" 
                            Margin="0,-1">
                            <Grid Margin="12,8,12,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Margin="0,-7,0,-4" 
                                           Text="{Binding Status, Converter={StaticResource MessageStatusConverter}}" 
                                           Foreground="#99FFFFFF" 
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                <TextBlock Grid.Column="1" micro:Message.Attach="[Event Tap] = [Action Resend($DataContext)]" 
                                           Text="{Binding Resources.Retry, Source={StaticResource Strings}}" 
                                           TextDecorations="Underline" 
                                           Margin="4,-7,0,-4" Foreground="#FFFFFFFF"
                                           FontFamily="{StaticResource PhoneFontFamilyNormal}" 
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Visibility="{Binding Status, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=Failed}"/>
                                <!--<TextBlock Grid.Column="3" Margin="0,-7,4,-4"
                                           Text="{Binding Id}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>-->
                                <Grid Grid.Column="3" Visibility="{Binding ViewsVisibility}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition/>
                                    </Grid.ColumnDefinitions>
                                    <Image Margin="6,0,0,0" Height="{Binding DefaultSystemIconSize, Source={StaticResource ScaledText}}" Stretch="UniformToFill" Source="/Images/Messages/message.state.views-WXGA.png"/>
                                    <TextBlock Grid.Column="1" Margin="4,-7,4,-4"
                                           Text="{Binding Views, Converter={StaticResource MessageViewsConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                </Grid>
                                <TextBlock Grid.Column="4" Margin="0,-7,0,-4"
                                           Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                <Image Grid.Column="5" Margin="6,0,0,0" Height="{Binding DefaultSystemIconSize, Source={StaticResource ScaledText}}" Stretch="UniformToFill" Source="{Binding Status, Converter={StaticResource StatusToImageConverter}}"/>
                            </Grid>
                        </Border>
                    </StackPanel>
                    <Path Grid.Row="1" Grid.Column="2" Margin="0,0,36,0" x:Name="RightBottomCorner" Fill="{Binding Converter={StaticResource OverlayAccentBrush}}"  HorizontalAlignment="Right" VerticalAlignment="Top" Data="F1 M0,0 L1,1 L1,0" Width="12" Height="12" Stretch="Fill"/>
                </Grid>
                <Border x:Name="SelectionBorder" 
                        Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" 
                        Hold="UIElement_OnHold" 
                        micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  
                        Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="UserStickerTemplate">
            <Grid x:Name="MainItemGrid2">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu Loaded="StickerContextMenu_OnLoaded" IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Opened="ContextMenu_OnOpened">
                        <toolkit:MenuItem Loaded="ReplyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="DeleteMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="ForwardMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="AddToStickers_OnLoaded" micro:Message.Attach="[Event Click] = [Action AddToStickers($DataContext)]" Header="{Binding Resources.AddToStickers, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>

                <Grid x:Name="MainItemGrid" >
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="1" VerticalAlignment="Bottom" Margin="30,30,24,24" Visibility="{Binding ReplyVisibility}">
                        <Border Grid.ColumnSpan="5" Margin="-6" HorizontalAlignment="Stretch" Background="{Binding DataContext.ReplyBackgroundBrush, ElementName=Self}"/>
                        <ContentControl
                            Background="Transparent" 
                            micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                            Content="{Binding ReplyInfo.Reply}" 
                            Margin="6,6,6,6"
                            ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                            HorizontalContentAlignment="Stretch"
                            HorizontalAlignment="Stretch"/>
                    </Grid>

                    <Grid Grid.Column="2" Margin="0,12,24,12" Background="Transparent">
                        <Grid>
                            <!--<Border VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>-->
                            <Image 
                                Stretch="Fill" 
                                Source="{Binding Media.Document, Converter={StaticResource DefaultPhotoConverter}}"
                                Height="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Height}"
                                Width="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Width}"/>
                        </Grid>

                        <Border HorizontalAlignment="Right" VerticalAlignment="Bottom">
                            <Grid Margin="12,8,12,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.ColumnSpan="5" Margin="-6" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>
                                <TextBlock Grid.Column="0" Margin="0,-7,0,-4" 
                                           Text="{Binding Status, Converter={StaticResource MessageStatusConverter}}" 
                                           Foreground="#99FFFFFF" 
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                <TextBlock Grid.Column="1" micro:Message.Attach="[Event Tap] = [Action Resend($DataContext)]" 
                                           Text="{Binding Resources.Retry, Source={StaticResource Strings}}" 
                                           TextDecorations="Underline" 
                                           Margin="4,-7,0,-4" 
                                           Foreground="#99FFFFFF"
                                           FontFamily="{StaticResource PhoneFontFamilyNormal}" 
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Visibility="{Binding Status, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=Failed}"/>
                                <TextBlock Grid.Column="3" Margin="0,-7,6,-4" 
                                           Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                <Image Grid.Column="4" Width="18" Stretch="UniformToFill" Source="{Binding Status, Converter={StaticResource StatusToImageConverter}}"/>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
                <Border x:Name="SelectionBorder" 
                        Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" 
                        Hold="UIElement_OnHold" 
                        micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  
                        Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ChatStickerTemplate">
            <Grid x:Name="MainItemGrid2">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Opened="ContextMenu_OnOpened">
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Loaded="ReplyMenuItem_OnLoaded" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Loaded="DeleteMenuItem_OnLoaded" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Loaded="ForwardMenuItem_OnLoaded" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action AddToStickers($DataContext)]" Loaded="AddToStickers_OnLoaded" Header="{Binding Resources.AddToStickers, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                        <toolkit:MenuItem Click="MoreMenuItem_OnClick" Loaded="MoreMenuItem_OnLoaded" Header="{Binding Resources.More, Source={StaticResource Strings}, Converter={StaticResource Lowercase}, StringFormat='\{0\}...'}" />
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>
                <Grid x:Name="MainItemGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid x:Name="grid" Grid.Row="1" Grid.Column="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="24" />
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!--<Grid Background="Transparent" micro:Message.Attach="[Event Tap]=[Action ShowUserProfile($DataContext)]">
                            <Grid Margin="24,0,0,0" Width="45" Height="45" VerticalAlignment="Top">
                                <Border Background="{Binding From.Index, Converter={StaticResource PlaceholderBackgroundConverter}}"/>
                                <TextBlock FontSize="19" Margin="0,-2,0,0" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" Text="{Binding From, Converter={StaticResource PlaceholderDefaultTextConverter}}"/>
                                <Image Source="{Binding From.Photo, Converter={StaticResource DefaultPhotoConverter}}" Stretch="UniformToFill"/>
                            </Grid>
                        </Grid>-->

                        <Grid Grid.Column="2" Margin="0,0,0,12">
                            <Grid>
                                <!--<Border VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>-->
                                <Image 
                                    Stretch="Fill" 
                                    Source="{Binding Media.Document, Converter={StaticResource DefaultPhotoConverter}}"
                                    Height="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Height}"
                                    Width="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Width}"/>
                            </Grid>

                            <Grid Margin="12,8,12,12"
                                  HorizontalAlignment="Right"
                                  VerticalAlignment="Bottom">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.ColumnSpan="3" Margin="-6" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>
                                <Grid Grid.Column="1" Visibility="{Binding ViewsVisibility}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition/>
                                    </Grid.ColumnDefinitions>
                                    <Image Margin="6,0,0,0" Height="{Binding DefaultSystemIconSize, Source={StaticResource ScaledText}}" Stretch="UniformToFill" Source="/Images/Messages/message.state.views-WXGA.png"/>
                                    <TextBlock Grid.Column="1" Margin="4,-7,8,-4"
                                           Text="{Binding Views, Converter={StaticResource MessageViewsConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                </Grid>
                                <TextBlock Grid.Column="2" Margin="0,-7,0,-4" 
                                    Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                    Foreground="#99FFFFFF" 
                                    FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                    Style="{StaticResource PhoneTextSubtleStyle}"/>
                            </Grid>
                        </Grid>

                        <Grid Grid.Column="3" VerticalAlignment="Bottom" Margin="24,30,30,24" Visibility="{Binding ReplyVisibility}">
                            <Border Grid.ColumnSpan="5" Margin="-6" HorizontalAlignment="Stretch" Background="{Binding DataContext.ReplyBackgroundBrush, ElementName=Self}"/>
                            <ContentControl
                                Background="Transparent" 
                                micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                                Content="{Binding ReplyInfo.Reply}" 
                                Margin="6,6,6,6"
                                ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                                HorizontalContentAlignment="Stretch"
                                HorizontalAlignment="Stretch"/>
                        </Grid>

                        <!--<Border Grid.Column="4" Width="38" Height="38" Margin="12,0,0,12"
                            micro:Message.Attach="[Event Tap] = [Action ForwardMessage($DataContext)]"
                            Background="{StaticResource PhoneChromeBrush}" 
                            VerticalAlignment="Bottom" HorizontalAlignment="Left">
                            <Image Width="20" Stretch="Uniform" Source="/Images/Messages/channel.share.black.png" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Border>-->
                    </Grid>
                </Grid>
                <Border x:Name="SelectionBorder" Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" Hold="UIElement_OnHold" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>
        
        <DataTemplate x:Key="ChatMessageTemplate">
            <Grid x:Name="MainItemGrid2">
                <Grid x:Name="MainItemGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid x:Name="grid" Grid.Row="1" Grid.Column="1">
                        <toolkit:ContextMenuService.ContextMenu>
                            <toolkit:ContextMenu IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Loaded="StickerContextMenu_OnLoaded" Opened="ContextMenu_OnOpened">
                                <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Loaded="ReplyMenuItem_OnLoaded" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                                <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Loaded="DeleteMenuItem_OnLoaded" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                                <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Loaded="ForwardMenuItem_OnLoaded" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                                <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action CopyMessage($DataContext)]" Header="{Binding Resources.Copy, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" Visibility="{Binding Converter={StaticResource TextMessageToVisibilityConverter}}" />
                                <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action SaveMedia($DataContext)]" Header="{Binding Resources.Save, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" Visibility="{Binding Self, Converter={StaticResource MediaFileAvailableToVisibilityConverter}}"/>
                                <toolkit:MenuItem Click="MoreMenuItem_OnClick" Loaded="MoreMenuItem_OnLoaded" Header="{Binding Resources.More, Source={StaticResource Strings}, Converter={StaticResource Lowercase}, StringFormat='\{0\}...'}" />
                            </toolkit:ContextMenu>
                        </toolkit:ContextMenuService.ContextMenu>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="24" />
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!--Accent overlay-->
                        <Path Grid.Column="1" HorizontalAlignment="Right" Margin="0,19,0,0" VerticalAlignment="Top" Data="F1 M0,0 L1,1 L1,0" Width="12" Height="12" Stretch="Fill">
                            <Path.Fill>
                                <SolidColorBrush Color="{StaticResource PhoneAccentColor}"/>
                            </Path.Fill>
                        </Path>
                        <Border Grid.Column="2" Margin="0,0,0,12">
                            <Border.Background>
                                <SolidColorBrush Color="{StaticResource PhoneAccentColor}"/>
                            </Border.Background>
                        </Border>

                        <!--Message content-->
                        <StackPanel Grid.Column="2" Margin="0,0,0,12" Background="{StaticResource PhoneAccentBrush}">
                            <Border Margin="0,0,0,-50" Background="{StaticResource PhoneAccentBrush}">
                                <StackPanel Margin="0,6,0,50">
                                    <TextBlock Text="{Binding From.FullName}"
                                               Visibility="{Binding Media, Converter={StaticResource MediaEmptyToVisibilityConverter}}" 
                                               Foreground="#99FFFFFF" 
                                               HorizontalAlignment="Left" 
                                               TextTrimming="WordEllipsis" 
                                               MaxWidth="260" MaxHeight="24.83"
                                               Style="{StaticResource PhoneTextSmallStyle}"/>
                                    <Grid Background="Transparent" micro:Message.Attach="[Event Tap] = [Action OpenFwdContactDetails($DataContext)]" 
                                        Visibility="{Binding FwdFromPeerVisibility, FallbackValue=Collapsed}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.ColumnSpan="2" Text="{Binding Resources.ForwardedMessage, Source={StaticResource Strings}}" Foreground="#99FFFFFF" Margin="12,-3,0,0" Style="{StaticResource PhoneTextSmallStyle}"/>
                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Resources.From, Source={StaticResource Strings}, StringFormat='\{0\} '}" Margin="12,-3,0,0" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding FwdFrom.FullName}" Margin="0,-3,0,0" HorizontalAlignment="Left" TextTrimming="WordEllipsis" MaxWidth="260" MaxHeight="24.83" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            <ContentControl
                                Background="Transparent" 
                                micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                                Width="{Binding ReplyWidth}"
                                Content="{Binding ReplyInfo.Reply}" 
                                Margin="12,8,12,6"
                                ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                                HorizontalContentAlignment="Stretch"
                                Visibility="{Binding ReplyVisibility}"
                                HorizontalAlignment="Stretch"/>
                            <Grid Canvas.ZIndex="2">
                                <emojiPanel:TelegramRichTextBox
                                    MaxHeight="1500"
                                    Width="335"
                                    Visibility="{Binding Media, Converter={StaticResource GeoLocationToVisibilityConverter}}"
                                    Text="{Binding Message}"
                                    emojiPanel:BrowserNavigationService.Message="{Binding}"
                                    TextScaleFactor="{Binding TextScaleFactor, Source={StaticResource ScaledText}}"
                                    MoreElement="{Binding ElementName=MorePanel}"
                                    FontSize="{Binding DefaultFontSize, Source={StaticResource ScaledText}}"
                                    Style="{StaticResource MessageBodyTelegramRichTextStyle}"/>
                                <Border x:Name="MorePanel" Background="{StaticResource PhoneAccentBrush}" VerticalAlignment="Bottom" Canvas.ZIndex="3" Visibility="Collapsed" Tap="MorePanel_OnTap">
                                    <TextBlock Canvas.ZIndex="4"
                                        Text="{Binding Resources.More, Source={StaticResource Strings}, StringFormat='\{0\}...'}" 
                                        TextDecorations="Underline" 
                                        Margin="12,0,12,0" Foreground="#FFFFFFFF"
                                        FontFamily="{StaticResource PhoneFontFamilyNormal}" 
                                        FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                        VerticalAlignment="Bottom" HorizontalAlignment="Right"/>
                                </Border>
                            </Grid>
                            <ContentControl
                                MaxHeight="1500"
                                Background="Transparent"
                                micro:Message.Attach="[Event Tap] = [Action OpenMedia($DataContext)]"
                                Margin="12,0,12,0"
                                HorizontalContentAlignment="Stretch"
                                HorizontalAlignment="Stretch"
                                Content="{Binding Media}"
                                ContentTemplate="{Binding Media, Converter={StaticResource MediaTemplateSelector}}"/>
                            <Border Margin="0,-1" 
                                Canvas.ZIndex="1"
                                Background="{StaticResource PhoneAccentBrush}">
                                <Grid Margin="12,8,12,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <!--<TextBlock Grid.Column="0" Margin="0,-7,4,-4"
                                           Text="{Binding ReplyMarkup}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                    <TextBlock Grid.Column="2" Margin="0,-7,4,-4"
                                           Text="{Binding Id}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>-->
                                    <Grid Grid.Column="2" Visibility="{Binding ViewsVisibility}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition/>
                                            <ColumnDefinition/>
                                        </Grid.ColumnDefinitions>
                                        <Image Margin="6,0,0,0" Height="{Binding DefaultSystemIconSize, Source={StaticResource ScaledText}}" Stretch="UniformToFill" Source="/Images/Messages/message.state.views-WXGA.png"/>
                                        <TextBlock Grid.Column="1" Margin="4,-7,8,-4"
                                           Text="{Binding Views, Converter={StaticResource MessageViewsConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                    </Grid>
                                    <TextBlock Grid.Column="3" Margin="0,-7,0,-4" 
                                               Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                               Foreground="#99FFFFFF" 
                                               FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                               Style="{StaticResource PhoneTextSubtleStyle}"/>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </Grid>

                    <Button Grid.Column="2" Grid.Row="1" Margin="12,0,0,12" Width="38" Height="38"
                            VerticalAlignment="Bottom" HorizontalAlignment="Left" Background="{StaticResource PhoneChromeBrush}"
                            micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]"
                            Style="{StaticResource EmptyButtonStyle}">
                        <Image Width="20" Stretch="Uniform" Source="{Binding DataContext.ChannelShareImageSource, ElementName=Self}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Button>
                </Grid>
                <Border x:Name="SelectionBorder" Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" Hold="UIElement_OnHold" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ServiceMessageTemplate">
            <Grid Margin="48,12" x:Name="MainItemGrid2" Background="Transparent" micro:Message.Attach="[Event Tap] = [Action OpenServiceMessage($DataContext)]">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu Loaded="ServiceMessageContextMenu_OnLoaded" IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Opened="ContextMenu_OnOpened">
                        <toolkit:MenuItem Loaded="ReplyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>

                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid HorizontalAlignment="Center">
                    <Border Margin="-6" Background="{StaticResource PhoneBackgroundBrush}" Opacity="0.3"/>
                    <StackPanel>
                        <!--<TextBlock Margin="6,0" TextAlignment="Center" TextWrapping="Wrap" FontSize="20" Text="{Binding Self, Converter={StaticResource ServiceMessageToTextConverter}}" Style="{StaticResource PhoneTextNormalStyle}"/>-->
                        <emojiPanel:TelegramRichTextBox
                            x:Name="Text"
                            Text="{Binding Self, Converter={StaticResource ServiceMessageToTextConverter}}"
                            TextAlignment="Center"
                            HorizontalAlignment="Stretch"
                            FontSize="20"
                            Foreground="{StaticResource PhoneForegroundBrush}"
                            Style="{StaticResource MessageBodyTelegramRichTextStyle}"/>
                        <!--<TextBlock Margin="6,0" TextAlignment="Left" TextWrapping="Wrap" FontSize="20" 
                            Text="{Binding Self, Converter={StaticResource ServiceMessageToText2Converter}}"
                            Visibility="{Binding Self, Converter={StaticResource ServiceMessageToText2VisibilityConverter}}"
                            Style="{StaticResource PhoneTextNormalStyle}"/>-->
                    </StackPanel>
                </Grid>
                
                <Grid Grid.Row="1" 
                      Background="Transparent"
                      Width="100" Height="100" Margin="0,12,0,0"
                      micro:Message.Attach="[Event Tap] = [Action OpenMedia($DataContext)]"
                      Visibility="{Binding Action.Photo, Converter={StaticResource ExistsToVisibilityConverter}, FallbackValue=Collapsed}">
                    <Border Background="{StaticResource PhoneChromeBrush}"/>
                    <Image Source="{Binding Action.Photo, Converter={StaticResource DefaultPhotoConverter}, ConverterParameter=100}" Stretch="UniformToFill"/>
                </Grid>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="UnreadMessagesTemplate">
            <Grid Margin="30,12" x:Name="MainItemGrid2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid HorizontalAlignment="Stretch">
                    <Border Margin="-6" Background="{StaticResource PhoneChromeBrush}" Height="48"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Margin="0,-2,6,0" VerticalAlignment="Center" TextAlignment="Center" TextWrapping="Wrap" FontSize="22.667" Text="{Binding Converter={StaticResource ServiceMessageToTextConverter}}" Style="{StaticResource PhoneTextSubtleStyle}"/>
                        <Image Source="/Images/Messages/unreadmessages.png" Width="11">
                            <Image.RenderTransform>
                                <TranslateTransform Y="2"/>
                            </Image.RenderTransform>
                        </Image>
                    </StackPanel>
                </Grid>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="FriendMessageTemplate">
            <Grid x:Name="MainItemGrid2">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Opened="ContextMenu_OnOpened">
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" />
                        <toolkit:MenuItem Loaded="ForwardMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="CopyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action CopyMessage($DataContext)]" Header="{Binding Resources.Copy, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action SaveMedia($DataContext)]" Header="{Binding Resources.Save, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" 
                                          Visibility="{Binding Self, Converter={StaticResource MediaFileAvailableToVisibilityConverter}}"/>
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>

                <Grid x:Name="MainItemGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="12" />
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Path x:Name="LeftUpCorner" Grid.Column="1" HorizontalAlignment="Left" Fill="{StaticResource PhoneAccentBrush}"  Margin="36,0,0,0" VerticalAlignment="Bottom" Data="F1 M0,0 L0,1 L1,1" Width="12" Height="12" Stretch="Fill"/>

                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="24,0,0,12" Background="{StaticResource PhoneAccentBrush}">
                        <ContentControl
                            Background="Transparent" 
                            micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                            Width="{Binding ReplyWidth}"
                            Content="{Binding ReplyInfo.Reply}" 
                            Margin="12,8,12,6"
                            ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                            HorizontalContentAlignment="Stretch"
                            Visibility="{Binding ReplyVisibility}"
                            HorizontalAlignment="Stretch"/>
                        <Grid 
                            Background="Transparent" 
                            micro:Message.Attach="[Event Tap] = [Action OpenFwdContactDetails($DataContext)]" 
                            Visibility="{Binding FwdFromPeerVisibility, FallbackValue=Collapsed}">
                            <Grid Margin="0,6,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.ColumnSpan="2" Text="{Binding Resources.ForwardedMessage, Source={StaticResource Strings}}" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Resources.From, Source={StaticResource Strings}, StringFormat='\{0\} '}" Margin="12,-3,0,0" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding FwdFrom.FullName}" Margin="0,-3,0,0" HorizontalAlignment="Left" TextTrimming="WordEllipsis" MaxWidth="260" MaxHeight="24.83" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                            </Grid>
                        </Grid>
                        <Grid Canvas.ZIndex="2">
                            <emojiPanel:TelegramRichTextBox
                                MaxHeight="1500"
                                Visibility="{Binding Media, Converter={StaticResource GeoLocationToVisibilityConverter}}"
                                Width="335"
                                Text="{Binding Message}"
                                TextScaleFactor="{Binding TextScaleFactor, Source={StaticResource ScaledText}}"
                                MoreElement="{Binding ElementName=MorePanel}"
                                FontSize="{Binding DefaultFontSize, Source={StaticResource ScaledText}}"
                                Style="{StaticResource MessageBodyTelegramRichTextStyle}"/>
                            <Border x:Name="MorePanel" Background="{StaticResource PhoneAccentBrush}" VerticalAlignment="Bottom" Canvas.ZIndex="3" Visibility="Collapsed" Tap="MorePanel_OnTap">
                                <TextBlock Canvas.ZIndex="4"
                                    Text="{Binding Resources.More, Source={StaticResource Strings}, StringFormat='\{0\}...'}" 
                                    TextDecorations="Underline" 
                                    Margin="12,0,12,0" Foreground="#FFFFFFFF"
                                    FontFamily="{StaticResource PhoneFontFamilyNormal}" 
                                    FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                    VerticalAlignment="Bottom" HorizontalAlignment="Right"/>
                            </Border>
                        </Grid>
                        <ContentControl
                            MaxHeight="1500"
                            Background="Transparent"
                            micro:Message.Attach="[Event Tap] = [Action OpenMedia($DataContext)]"
                            Margin="12,6,12,0"
                            HorizontalContentAlignment="Stretch"
                            HorizontalAlignment="Stretch"
                            Content="{Binding Media}"
                            ContentTemplate="{Binding Media, Converter={StaticResource MediaTemplateSelector}}"/>
                        <Border Canvas.ZIndex="1" Margin="0,-1" Background="{StaticResource PhoneAccentBrush}">
                            <Grid Margin="12,8,12,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <!--<StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <TextBlock
                                           Margin="0,-7,0,-4" 
                                           Text="{Binding ReplyMarkup}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                    <TextBlock
                                           Margin="6,-7,0,-4" 
                                           Text="{Binding Unread, Converter={StaticResource UnreadMessageConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                </StackPanel>-->
                                <Grid Grid.Column="2" Visibility="{Binding ViewsVisibility}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition/>
                                    </Grid.ColumnDefinitions>
                                    <Image Margin="6,0,0,0" Height="{Binding DefaultSystemIconSize, Source={StaticResource ScaledText}}" Stretch="UniformToFill" Source="/Images/Messages/message.state.views-WXGA.png"/>
                                    <TextBlock Grid.Column="1" Margin="4,-7,8,-4"
                                           Text="{Binding Views, Converter={StaticResource MessageViewsConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                </Grid>
                                <TextBlock Grid.Column="3" 
                                           Margin="0,-7,0,-4" 
                                           Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                            </Grid>
                        </Border>
                    </StackPanel>
                </Grid>
                <!--</ctrls:LayoutTransformer>-->
                <Border x:Name="SelectionBorder" Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" Hold="UIElement_OnHold" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="FriendStickerTemplate">
            <Grid x:Name="MainItemGrid2">

                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Opened="ContextMenu_OnOpened">
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="ForwardMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="AddToStickers_OnLoaded" micro:Message.Attach="[Event Click] = [Action AddToStickers($DataContext)]" Header="{Binding Resources.AddToStickers, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>                        
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>

                <Grid x:Name="MainItemGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="12" />
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Row="1" Grid.Column="1" Margin="24,0,0,12">
                        <Grid>
                            <!--<Border VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>-->
                            <Image 
                                Stretch="Fill" 
                                Source="{Binding Media.Document, Converter={StaticResource DefaultPhotoConverter}}"
                                Height="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Height}"
                                Width="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Width}"/>
                        </Grid>
                        <Grid Margin="12,8,12,12"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Bottom">
                            <Border Margin="-6" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>
                            <TextBlock
                                Margin="0,-7,0,-4" 
                                Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                Foreground="#99FFFFFF"
                                FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                Style="{StaticResource PhoneTextSubtleStyle}"/>
                        </Grid>
                    </Grid>

                    <Grid Grid.Row="1" Grid.Column="2" VerticalAlignment="Bottom" Margin="24,30,30,24" Visibility="{Binding ReplyVisibility}">
                        <Border Grid.ColumnSpan="5" Margin="-6" HorizontalAlignment="Stretch" Background="{Binding DataContext.ReplyBackgroundBrush, ElementName=Self}"/>
                        <ContentControl 
                            Background="Transparent" 
                            micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                            Content="{Binding ReplyInfo.Reply}" 
                            Margin="6,6,6,6"
                            ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                            HorizontalContentAlignment="Stretch"
                            HorizontalAlignment="Stretch"/>
                    </Grid>
                </Grid>
                <Border x:Name="SelectionBorder" Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" Hold="UIElement_OnHold" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ChatFriendStickerTemplate">
            <Grid x:Name="MainItemGrid2">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu Opened="ContextMenu_OnOpened" IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}">
                        <toolkit:MenuItem Loaded="ReplyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="DeleteMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="ForwardMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="AddToStickers_OnLoaded" micro:Message.Attach="[Event Click] = [Action AddToStickers($DataContext)]" Header="{Binding Resources.AddToStickers, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>
                <Grid x:Name="MainItemGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid x:Name="grid" Grid.Row="1" Grid.Column="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="69" />
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Grid Background="Transparent" micro:Message.Attach="[Event Tap]=[Action ShowUserProfile($DataContext)]">
                            <Grid Margin="24,0,0,0" Width="45" Height="45" VerticalAlignment="Top">
                                <Border Background="{Binding From.Index, Converter={StaticResource PlaceholderBackgroundConverter}}"/>
                                <TextBlock FontSize="19" Margin="0,-2,0,0" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" Text="{Binding From, Converter={StaticResource PlaceholderDefaultTextConverter}}"/>
                                <Image Source="{Binding From.Photo, Converter={StaticResource DefaultPhotoConverter}}" Stretch="UniformToFill"/>
                            </Grid>
                        </Grid>

                        <Grid Grid.Column="2" Margin="0,0,0,12">
                            <Grid>
                                <!--<Border VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>-->
                                <Image 
                                    Stretch="Fill" 
                                    Source="{Binding Media.Document, Converter={StaticResource DefaultPhotoConverter}}"
                                    Height="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Height}"
                                    Width="{Binding Media.Document, Converter={StaticResource StickerToDimensionConverter}, ConverterParameter=Width}"/>
                            </Grid>

                            <Grid Margin="12,8,12,12"
                                  HorizontalAlignment="Right"
                                  VerticalAlignment="Bottom">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.ColumnSpan="2" Margin="-6" HorizontalAlignment="Stretch" Background="Black" Opacity="0.4"/>
                                <TextBlock Grid.Column="1" Margin="0,-7,0,-4" 
                                    Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                    Foreground="#99FFFFFF" 
                                    FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                    Style="{StaticResource PhoneTextSubtleStyle}"/>
                            </Grid>
                        </Grid>

                        <Grid Grid.Column="3" VerticalAlignment="Bottom" Margin="24,30,30,24" Visibility="{Binding ReplyVisibility}">
                            <Border Grid.ColumnSpan="5" Margin="-6" HorizontalAlignment="Stretch" Background="{Binding DataContext.ReplyBackgroundBrush, ElementName=Self}"/>
                            <ContentControl
                                Background="Transparent" 
                                micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                                Content="{Binding ReplyInfo.Reply}" 
                                Margin="6,6,6,6"
                                ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                                HorizontalContentAlignment="Stretch"
                                HorizontalAlignment="Stretch"/>
                        </Grid>
                    </Grid>
                </Grid>
                <Border x:Name="SelectionBorder" Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" Hold="UIElement_OnHold" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ChatFriendMessageTemplate">
            <Grid x:Name="MainItemGrid2">
                <toolkit:ContextMenuService.ContextMenu>
                    <toolkit:ContextMenu IsZoomEnabled="False" micro:Action.TargetWithoutContext="{Binding DataContext, ElementName=Items}" Opened="ContextMenu_OnOpened">
                        <toolkit:MenuItem Loaded="ReplyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ReplyMessage($DataContext)]" Header="{Binding Resources.Reply, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="DeleteMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action DeleteMessage($DataContext)]" Header="{Binding Resources.Delete, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="ForwardMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action ForwardMessage($DataContext)]" Header="{Binding Resources.Forward, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem Loaded="CopyMessage_OnLoaded" micro:Message.Attach="[Event Click] = [Action CopyMessage($DataContext)]" Header="{Binding Resources.Copy, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}"/>
                        <toolkit:MenuItem micro:Message.Attach="[Event Click] = [Action SaveMedia($DataContext)]" Header="{Binding Resources.Save, Source={StaticResource Strings}, Converter={StaticResource Lowercase}}" 
                                          Visibility="{Binding Self, Converter={StaticResource MediaFileAvailableToVisibilityConverter}}"/>
                    </toolkit:ContextMenu>
                </toolkit:ContextMenuService.ContextMenu>
                <Grid x:Name="MainItemGrid">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid x:Name="grid" Grid.Row="1" Grid.Column="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="69" />
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>


                        <!--Photo-->
                        <Grid Background="Transparent" micro:Message.Attach="[Event Tap]=[Action ShowUserProfile($DataContext)]">
                            <Grid Margin="24,0,0,0" Width="45" Height="45" VerticalAlignment="Top">
                                <Border Background="{Binding From.Index, Converter={StaticResource PlaceholderBackgroundConverter}}"/>
                                <TextBlock FontSize="19" Margin="0,-2,0,0" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" Text="{Binding From, Converter={StaticResource PlaceholderDefaultTextConverter}}"/>
                                <Image Source="{Binding From.Photo, Converter={StaticResource DefaultPhotoConverter}}" Stretch="UniformToFill"/>
                            </Grid>
                        </Grid>



                        <!--Accent overlay-->
                        <Path Grid.Column="1" HorizontalAlignment="Right" Margin="0,19,0,0" VerticalAlignment="Top" Data="F1 M0,0 L1,1 L1,0" Width="12" Height="12" Stretch="Fill">
                            <Path.Fill>
                                <SolidColorBrush Color="{StaticResource PhoneAccentColor}"/>
                            </Path.Fill>
                        </Path>
                        <Border Grid.Column="2" Margin="0,0,0,12">
                            <Border.Background>
                                <SolidColorBrush Color="{StaticResource PhoneAccentColor}"/>
                            </Border.Background>
                        </Border>

                        <!--Message content-->
                        <StackPanel Grid.Column="2" Margin="0,0,0,12" Background="{StaticResource PhoneAccentBrush}">
                            <Border Margin="0,0,0,-50" Background="{StaticResource PhoneAccentBrush}">
                                <StackPanel Margin="0,6,0,50">
                                    <TextBlock Text="{Binding From.FullName}" 
                                               Visibility="{Binding Media, Converter={StaticResource MediaEmptyToVisibilityConverter}}" 
                                               MaxHeight="24.83" 
                                               Foreground="#99FFFFFF" 
                                               Style="{StaticResource PhoneTextSmallStyle}"/>
                                    <Grid Background="Transparent" micro:Message.Attach="[Event Tap] = [Action OpenFwdContactDetails($DataContext)]" 
                                          Visibility="{Binding FwdFromPeerVisibility, FallbackValue=Collapsed}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.ColumnSpan="2" Text="{Binding Resources.ForwardedMessage, Source={StaticResource Strings}}" Foreground="#99FFFFFF" Margin="12,-3,0,0" Style="{StaticResource PhoneTextSmallStyle}"/>
                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Resources.From, Source={StaticResource Strings}, StringFormat='\{0\} '}" Margin="12,-3,0,0" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding FwdFrom.FullName}" Margin="0,-3,0,0" HorizontalAlignment="Left" TextTrimming="WordEllipsis" MaxWidth="260" MaxHeight="24.83" Foreground="#99FFFFFF" Style="{StaticResource PhoneTextSmallStyle}"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            <ContentControl
                                Background="Transparent" 
                                micro:Message.Attach="[Event Tap] = [Action OpenReply($DataContext)]" 
                                Width="{Binding ReplyWidth}"
                                Content="{Binding ReplyInfo.Reply}" 
                                Margin="12,8,12,6"
                                ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                                HorizontalContentAlignment="Stretch"
                                Visibility="{Binding ReplyVisibility}"
                                HorizontalAlignment="Stretch"/>
                            <Grid Canvas.ZIndex="2">
                                <emojiPanel:TelegramRichTextBox
                                    MaxHeight="1500"
                                    Width="335"
                                    Visibility="{Binding Media, Converter={StaticResource GeoLocationToVisibilityConverter}}"
                                    Text="{Binding Message}"
                                    emojiPanel:BrowserNavigationService.Message="{Binding}"
                                    TextScaleFactor="{Binding TextScaleFactor, Source={StaticResource ScaledText}}"
                                    MoreElement="{Binding ElementName=MorePanel}"
                                    FontSize="{Binding DefaultFontSize, Source={StaticResource ScaledText}}"
                                    Style="{StaticResource MessageBodyTelegramRichTextStyle}"/>
                                <Border x:Name="MorePanel" Background="{StaticResource PhoneAccentBrush}" VerticalAlignment="Bottom" Canvas.ZIndex="3" Visibility="Collapsed" Tap="MorePanel_OnTap">
                                    <TextBlock Canvas.ZIndex="4"
                                        Text="{Binding Resources.More, Source={StaticResource Strings}, StringFormat='\{0\}...'}" 
                                        TextDecorations="Underline" 
                                        Margin="12,0,12,0" Foreground="#FFFFFFFF"
                                        FontFamily="{StaticResource PhoneFontFamilyNormal}" 
                                        FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                        VerticalAlignment="Bottom" HorizontalAlignment="Right"/>
                                </Border>
                            </Grid>
                            <ContentControl
                                MaxHeight="1500"
                                Background="Transparent"
                                micro:Message.Attach="[Event Tap] = [Action OpenMedia($DataContext)]"
                                Margin="12,0,12,0"
                                HorizontalContentAlignment="Stretch"
                                HorizontalAlignment="Stretch"
                                Content="{Binding Media}"
                                ContentTemplate="{Binding Media, Converter={StaticResource MediaTemplateSelector}}"/>
                            <Border Margin="0,-1" 
                                Canvas.ZIndex="1"
                                Background="{StaticResource PhoneAccentBrush}">
                                <Grid Margin="12,8,12,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <!--<TextBlock Grid.Column="0" Margin="0,-7,4,-4"
                                           Text="{Binding ReplyMarkup}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>
                                    <TextBlock Grid.Column="2" Margin="0,-7,4,-4"
                                           Text="{Binding Id}" 
                                           Foreground="#99FFFFFF"
                                           FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                           Style="{StaticResource PhoneTextSubtleStyle}"/>-->
                                    <TextBlock Grid.Column="3" Margin="0,-7,0,-4" 
                                               Text="{Binding Date, Converter={StaticResource MessageDateTimeConverter}}" 
                                               Foreground="#99FFFFFF" 
                                               FontSize="{Binding DefaultSystemFontSize, Source={StaticResource ScaledText}}"
                                               Style="{StaticResource PhoneTextSubtleStyle}"/>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </Grid>
                </Grid>
                <Border x:Name="SelectionBorder" Background="{Binding IsSelected, Converter={StaticResource IsSelectedToBackgroundConverter}}" Hold="UIElement_OnHold" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"  Visibility="{Binding DataContext.IsSelectionEnabled, ElementName=Self, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <templateSelectors:MessageTemplateSelector 
            x:Key="MessageTemplateSelector"
            UserMessageTemplate="{StaticResource UserMessageTemplate}"
            UserStickerTemplate="{StaticResource UserStickerTemplate}"
            ChatFriendMessageTemplate="{StaticResource ChatFriendMessageTemplate}"
            ChatFriendStickerTemplate="{StaticResource ChatFriendStickerTemplate}"
            FriendMessageTemplate="{StaticResource FriendMessageTemplate}"
            FriendStickerTemplate="{StaticResource FriendStickerTemplate}"
            ServiceMessageTemplate="{StaticResource ServiceMessageTemplate}"
            UnreadMessagesTemplate="{StaticResource UnreadMessagesTemplate}"
            ChatMessageTemplate="{StaticResource ChatMessageTemplate}"
            ChatStickerTemplate="{StaticResource ChatStickerTemplate}"/>
        
        <DataTemplate x:Key="UserTemplate">
            <Grid>
                <Border Margin="-12" Background="{StaticResource PhoneBackgroundBrush}" Opacity="0.3"/>
                <StackPanel Margin="0,40,0,0">
                    <Grid Width="81">
                        <Image Source="{Binding EmptyDialogImageSource}" Stretch="UniformToFill"/>
                    </Grid>
                    <TextBlock Text="{Binding Resources.NoMessagesYet, Source={StaticResource Strings}}" TextWrapping="Wrap" Margin="48,40,48,0" FontSize="{StaticResource PhoneFontSizeMedium}" Style="{StaticResource PhoneTextGroupHeaderStyle}"/>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="BotTemplate">
            <StackPanel Margin="48,0,48,0" Background="{StaticResource PhoneAccentBrush}">
                <TextBlock Text="{Binding Resources.WhatCanThisBotDo, Source={StaticResource Strings}}" TextWrapping="Wrap" Margin="12,6" FontSize="{StaticResource PhoneFontSizeMedium}" Style="{StaticResource PhoneTextGroupHeaderStyle}"/>

                <emojiPanel:TelegramRichTextBox
                    Width="360"
                    Margin="0,0,0,12"
                    Text="{Binding With.BotInfo.Description}"
                    HorizontalAlignment="Stretch"
                    TextScaleFactor="{Binding TextScaleFactor, Source={StaticResource ScaledText}}"
                    FontSize="{Binding DefaultFontSize, Source={StaticResource ScaledText}}"
                    Style="{StaticResource MessageBodyTelegramRichTextStyle}"/>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="SupportTemplate">
            <Grid>
                <Border Margin="-12" Background="{StaticResource PhoneBackgroundBrush}" Opacity="0.3"/>
                <StackPanel Margin="0,40,0,0">
                    <Grid Width="81">
                        <Image Source="{Binding EmptyDialogImageSource}" Stretch="UniformToFill"/>
                    </Grid>
                    <TextBlock Text="{Binding Resources.GotAQuestionAboutTelegram, Source={StaticResource Strings}}" TextWrapping="Wrap" Margin="48,40,48,0" FontSize="{StaticResource PhoneFontSizeMedium}" Style="{StaticResource PhoneTextGroupHeaderStyle}"/>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <templateSelectors:EmptyDialogToDescriptionConverter
            x:Key="EmptyDialogToDescriptionConverter"
            UserTemplate="{StaticResource UserTemplate}"
            BotTemplate="{StaticResource BotTemplate}"
            SupportTemplate="{StaticResource SupportTemplate}"/>
    </views:TelegramViewBase.Resources>
    
    <Grid>
        <ContentControl x:Name="MediaControl" IsHitTestVisible="False"/>
        <!--<profiling:MemoryCounter/>-->
        <ContentControl 
            HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch" 
            HorizontalAlignment="Stretch" VerticalAlignment="Stretch"  
            Content="{Binding StateService}" 
            ContentTemplate="{Binding StateService.CurrentBackground, Converter={StaticResource DialogDetailsBackgroundConverter}}"/>

        <Grid x:Name="LayoutRoot" Background="Transparent">
            <Grid.RenderTransform>
                <CompositeTransform/>
            </Grid.RenderTransform>
            <Grid.Projection>
                <PlaneProjection CenterOfRotationX="0"/>
            </Grid.Projection>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Button Tap="OpenPeerDetails_OnTap"
                x:Name="Caption"
                toolkit:TiltEffect.IsTiltEnabled="True"
                Margin="-4,30,0,12" Grid.Row="0" VerticalAlignment="Bottom" Style="{StaticResource DialogDetailsCaptionButtonStyle}">
                <Button.RenderTransform>
                    <TranslateTransform/>
                </Button.RenderTransform>
                <StackPanel>
                    <StackPanel Orientation="Horizontal" x:Name="Title">
                        <StackPanel.RenderTransform>
                            <CompositeTransform/>
                        </StackPanel.RenderTransform>
                        <TextBlock HorizontalAlignment="Left" Text="{Binding With, Converter={StaticResource DialogCaptionConverter}}" MaxHeight="42.56" Foreground="{Binding StateService.CurrentForegroundBrush}" Style="{StaticResource PhoneTextTitle2Style}"/>

                        <!--<Border Background="{StaticResource PhoneAccentBrush}" Width="17" Height="17"
                            Visibility="{Binding With.IsVerified, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
                            HorizontalAlignment="Right" VerticalAlignment="Bottom"
                            Margin="-6,0,12,8">
                            <Border.OpacityMask>
                                <ImageBrush ImageSource="/Images/Dialogs/channel.check-WXGA.png" Stretch="Uniform"/>
                            </Border.OpacityMask>
                        </Border>-->
                        <Image Width="16" Height="16" VerticalAlignment="Bottom" Source="/Images/Dialogs/chat.mute-WXGA.png" Margin="-6,0,0,8" Visibility="{Binding With.NotifySettings, Converter={StaticResource NotifySettingsToVisibilityConverter}, FallbackValue=Collapsed}"/>
                    </StackPanel>
                    <TextBlock x:Name="Subtitle" Margin="12,-4,0,0" Foreground="{Binding StateService.CurrentForegroundSubtleBrush}" Style="{StaticResource PhoneTextSubtleStyle}"/>
                </StackPanel>
            </Button>

            <Border x:Name="DialogPhoto" Tap="OpenPeerDetails_OnTap" Margin="12,48,24,0" VerticalAlignment="Top" Grid.Row="0" Grid.Column="1" Width="54" Height="54" Background="{Binding With.Index, Converter={StaticResource PlaceholderBackgroundConverter}}">
                <Grid Background="Transparent">
                    <TextBlock FontSize="27" Margin="0,-2,0,0" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" Text="{Binding With, Converter={StaticResource PlaceholderDefaultTextConverter}}"/>
                    <Image Source="{Binding With.Photo, Converter={StaticResource DefaultPhotoConverter}}"/>
                </Grid>
            </Border>

            <Grid x:Name="ContentPanel" Grid.Row="1" Grid.ColumnSpan="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition x:Name="BottomAppBarPlaceholder" Height="72"/>
                </Grid.RowDefinitions>
                
                <telegramClient:LongListSelectorEx
                    x:Name="Items"
                    Margin="-4,-18,0,0"
                    Knob="15"
                    ItemsSource="{Binding Items}"
                    IsSelectionEnabled="{Binding IsSelectionEnabled}"
                    IsFirstSliceLoaded="{Binding IsFirstSliceLoaded}"
                    IsGroupingEnabled="False"
                    micro:Message.Attach="[Event CloseToEnd] = [Action LoadNextSlice]; [Event CloseToBegin] = [Action LoadPreviousSlice]"
                    ManipulationStarted="Items_OnManipulationStarted"
                    Begin="Items_OnBegin"
                    Style="{StaticResource LazyLongListSelectorStyle}">
                    <phone:LongListSelector.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid>
                                    <CheckBox Margin="12,0,18,0" IsChecked="{Binding IsSelected, Mode=TwoWay}" HorizontalAlignment="Right"
                                          Visibility="{Binding SelectionVisibility, FallbackValue=Collapsed}">
                                        <CheckBox.RenderTransform>
                                            <TranslateTransform X="2"/>
                                        </CheckBox.RenderTransform>
                                        <CheckBox.Projection>
                                            <PlaneProjection RotationZ="180"/>
                                        </CheckBox.Projection>
                                    </CheckBox>
                                    <Border Background="Transparent" micro:Message.Attach="[Event Tap] = [Action ChangeSelection($DataContext)]"/>
                                </Grid>
                                <ContentControl Margin="0,0,60,0"
                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" 
                                    Content="{Binding}" ContentTemplate="{Binding Converter={StaticResource MessageTemplateSelector}}">
                                    <ContentControl.Projection>
                                        <PlaneProjection RotationZ="180"/>
                                    </ContentControl.Projection>
                                </ContentControl>                                
                                <Border 
                                    Background="{StaticResource PhoneAccentBrush}" 
                                    Width="20" 
                                    HorizontalAlignment="Right" 
                                    Margin="0,12,60,12"
                                    Visibility="Collapsed"
                                    dialogs:DialogDetailsView.AnimatedVisibility="{Binding IsHighlighted}"/>
                            </Grid>
                        </DataTemplate>
                    </phone:LongListSelector.ItemTemplate>
                    <phone:LongListSelector.ListHeader>
                        <Border Visibility="Collapsed"/>
                    </phone:LongListSelector.ListHeader>
                    <phone:LongListSelector.Projection>
                        <PlaneProjection RotationZ="180"/>
                    </phone:LongListSelector.Projection>
                </telegramClient:LongListSelectorEx>
                
                <Image x:Name="MessagesCache" Source="{Binding With.Bitmap}" Margin="-4,-18,0,0" VerticalAlignment="Bottom">
                    <Image.Projection>
                        <PlaneProjection RotationZ="180"/>
                    </Image.Projection>
                </Image>
                
                <ContentControl 
                    Visibility="{Binding IsEmptyDialog, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Content="{Binding}" 
                    ContentTemplate="{Binding With, Converter={StaticResource EmptyDialogToDescriptionConverter}}"/>

                <!--<StackPanel Margin="6,6,-60,0" HorizontalAlignment="Left" VerticalAlignment="Bottom" Visibility="{Binding Converter={StaticResource DebugVisibilityConverter}}">
                    <TextBlock x:Name="ViewportText" Foreground="GreenYellow"/>
                    <TextBlock x:Name="BoundsText" Foreground="GreenYellow"/>
                </StackPanel>-->

                <Grid x:Name="ScrollButton" Margin="6,6,-60,0" HorizontalAlignment="Right" VerticalAlignment="Bottom" Visibility="Collapsed">
                    <Grid.RenderTransform>
                        <CompositeTransform Rotation="90"/>
                    </Grid.RenderTransform>
                    <Button Style="{StaticResource ScrollButtonStyle}" Click="ScrollButton_OnClick" toolkit:TiltEffect.IsTiltEnabled="True">
                        <Image Source="{Binding ScrollButtonImageSource}" Stretch="UniformToFill"/>
                    </Button>
                </Grid>

                <!-- Stickers -->
                <Grid VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Margin="121,-38,24,-12" Height="124">
                    <Grid.Resources>
                        <Storyboard x:Name="OpenStickersStoryboard" TargetName="StickersPanel" Completed="OpenStickersStoryboard_OnCompleted">
                            <DoubleAnimationUsingKeyFrames Storyboard.TargetProperty="(UIElement.RenderTransform).(CompositeTransform.TranslateY)" Storyboard.TargetName="StickersPanel">
                                <EasingDoubleKeyFrame KeyTime="0:0:0.00" Value="24"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="0">
                                    <EasingDoubleKeyFrame.EasingFunction>
                                        <ExponentialEase EasingMode="EaseOut" Exponent="5"/>
                                    </EasingDoubleKeyFrame.EasingFunction>
                                </EasingDoubleKeyFrame>
                            </DoubleAnimationUsingKeyFrames>
                            <DoubleAnimation From="0" To="1" Duration="0:0:0.25" Storyboard.TargetProperty="(UIElement.Opacity)">
                                <DoubleAnimation.EasingFunction>
                                    <ExponentialEase EasingMode="EaseOut" Exponent="5"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </Grid.Resources>
                    <Grid x:Name="StickersPanel" Visibility="Collapsed" CacheMode="BitmapCache">
                        <Grid.RenderTransform>
                            <CompositeTransform x:Name="StickersPanelTransform" TranslateY="124"/>
                        </Grid.RenderTransform>
                        <Border Background="White" Opacity="0.9" Height="124"/>
                        <ItemsControl x:Name="Stickers">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ListBoxItem toolkit:TiltEffect.IsTiltEnabled="True">
                                        <Image Source="{Binding Self, Converter={StaticResource DefaultPhotoConverter}}" Stretch="UniformToFill" Margin="12" MaxHeight="100" Tap="UIElement_OnTap"/>
                                    </ListBoxItem>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            <ItemsControl.Template>
                                <ControlTemplate TargetType="ItemsControl">
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                                        <ItemsPresenter/>
                                    </ScrollViewer>
                                </ControlTemplate>
                            </ItemsControl.Template>
                        </ItemsControl>
                    </Grid>
                </Grid>

                <Grid Visibility="{Binding IsAppBarCommandVisible, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=invert, FallbackValue=Collapsed}">

                    <!-- Usernames -->
                    <ContentControl x:Name="UsernameHints" 
                                VerticalAlignment="Bottom" HorizontalAlignment="Stretch" 
                                HorizontalContentAlignment="Stretch" 
                                Margin="121,-38,24,-12" MaxHeight="124"
                                Tap="UsernameHint_OnTap"
                                ManipulationStarted="UsernameHints_OnManipulationStarted"/>

                    <!-- Commands -->
                    <ContentControl x:Name="CommandHints" 
                                VerticalAlignment="Bottom" HorizontalAlignment="Stretch" 
                                HorizontalContentAlignment="Stretch" 
                                Margin="121,-38,24,-12" MaxHeight="124"
                                Tap="CommandHint_OnTap"
                                ManipulationStarted="CommandHints_OnManipulationStarted"/>

                    <!-- Hashtags -->
                    <ContentControl x:Name="HashtagHints" 
                                VerticalAlignment="Bottom" HorizontalAlignment="Stretch" 
                                HorizontalContentAlignment="Stretch" 
                                Margin="121,-38,24,-12" MaxHeight="124"
                                Tap="HashtagHint_OnTap"
                                Hold="HashtagHintsPanel_OnHold"
                                ManipulationStarted="HashtagHints_OnManipulationStarted"/>
                </Grid>

                <Grid Grid.Row="2" Visibility="{Binding IsAppBarCommandVisible, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=invert, FallbackValue=Collapsed}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid Visibility="{Binding Reply, Converter={StaticResource ExistsToVisibilityConverter}, FallbackValue=Collapsed}" Margin="121,12,24,-12" Background="{Binding Converter={StaticResource OverlayAccentBrush}}">
                        <ContentControl
                            x:Name="ReplyMessage" 
                            Content="{Binding Reply}" 
                            Height="66" Margin="12,0"
                            ContentTemplate="{Binding ReplyInfo, Converter={StaticResource ReplyTemplateSelector}}"
                            HorizontalContentAlignment="Stretch"
                            HorizontalAlignment="Stretch"/>
                        
                        <Border Background="Transparent" HorizontalAlignment="Right" VerticalAlignment="Top" micro:Message.Attach="[Event Tap] = [Action DeleteReply]">
                            <Image Source="/Images/Messages/message.deletereply.png" Width="13" Margin="8" Opacity="0.6"/>
                        </Border>
                    </Grid>

                    <telegramControls:AudioRecorderControl                   
                        Grid.Row="1"
                        MinHeight="62"
                        x:Name="AudioRecorder"
                        Margin="0,0,0,12"
                        UploadFileDuringRecording="True"
                        Foreground="{Binding StateService.CurrentForegroundBrush}"/>


                    <Grid Grid.Row="1">
                        <controls:WatermarkedTextBox 
                            x:Name="InputMessage"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Bottom"
                            Margin="109,0,12,12"
                            HorizontalContentAlignment="Left"             
                            KeyDown="InputMessage_OnKeyDown"
                            TextChanged="InputMessage_OnTextChanged"
                            GotFocus="InputMessage_OnGotFocus"
                            LostFocus="InputMessage_OnLostFocus"
                            Watermark="{Binding Resources.YourMessage, Converter={StaticResource Lowercase}, Source={StaticResource Strings}}"
                            WatermarkForeground="{Binding WatermarkForeground}"
                            Text="{Binding Text, Mode=TwoWay}"
                            MinHeight="48" MaxHeight="140" AcceptsReturn="True" 
                            TextWrapping="Wrap"
                            TextScaleFactor="{Binding TextScaleFactor, Source={StaticResource ScaledText}}"
                            FontSize="{Binding DefaultFontSize, Source={StaticResource ScaledText}}"
                            Style="{StaticResource MessageTextBoxStyle}"
                            InputScope="Text">
                            <controls:WatermarkedTextBox.RenderTransform>
                                <CompositeTransform/>
                            </controls:WatermarkedTextBox.RenderTransform>
                            <i:Interaction.Behaviors>
                                <behaviors:UpdateTextBindingBehavior/>
                            </i:Interaction.Behaviors>
                        </controls:WatermarkedTextBox>
                        <Button x:Name="ReplyKeyboardButton" Margin="0,0,12,12" VerticalAlignment="Center" HorizontalAlignment="Right" Click="ReplyKeyboardButton_OnClick" Visibility="Collapsed"
                                toolkit:TiltEffect.IsTiltEnabled="True"
                                Style="{StaticResource ReplyKeyboardButtonStyle}">
                            <Image x:Name="ReplyKeyboardButtonImage" Width="25" Height="25" Source="/Images/Dialogs/chat.customkeyboard-WXGA.png"/>
                        </Button>
                        <!--<Button toolkit:TiltEffect.IsTiltEnabled="True" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,0,0" Style="{StaticResource HiddenButtonStyle}" Click="ChannelBroadcastButton_OnClick" Visibility="{Binding ChannelVisibility}">
                            <Button.RenderTransform>
                                <TranslateTransform Y="-8" X="-18"/>
                            </Button.RenderTransform>
                            <Border Width="18" Height="18" Margin="-2,0,0,-3" Opacity="0" IsHitTestVisible="False" x:Name="BroadcastIcon" Background="{Binding ChannelMessageBrush}">
                                <Border.OpacityMask>
                                    <ImageBrush Stretch="Uniform" ImageSource="/Images/Messages/channel.broadcast-WXGA.png" ImageOpened="ImageBrush_OnImageOpened"/>
                                </Border.OpacityMask>
                            </Border>
                        </Button>-->
                    </Grid>
                </Grid>

                <Grid Grid.Row="3" Visibility="{Binding IsAppBarCommandVisible, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=invert, FallbackValue=Collapsed}">
                    <dialogs:CommandsControl x:Name="CommandsControl" ReplyMarkup="{Binding ReplyMarkup}" ButtonClick="CommandsControl_OnButtonClick" VerticalAlignment="Bottom" Visibility="Collapsed"/>
                    <ContentControl x:Name="EmojiPlaceholder" HorizontalContentAlignment="Stretch" Visibility="Collapsed"/>
                </Grid>
            </Grid>

            <ContentControl x:Name="UserAction" Grid.Row="1" Grid.ColumnSpan="2" VerticalAlignment="Top" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" Margin="0,-18,0,0"/>
            <ContentControl x:Name="SearchMessages" Grid.Row="1" Grid.ColumnSpan="2" VerticalAlignment="Top" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" Margin="0,-18,0,0"/>
            
            <Border x:Name="AppBarCommandPlaceholder" Height="72" Grid.ColumnSpan="5" Grid.RowSpan="5"
                    Visibility="{Binding IsAppBarCommandVisible, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"
                    HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Background="{StaticResource PhoneChromeBrush}">
                <Button Margin="12,-12" x:Name="AppBarCommand" VerticalAlignment="Center" VerticalContentAlignment="Center" Content="{Binding AppBarCommandString}"/>
            </Border>
            <ContentControl Grid.RowSpan="2" Grid.ColumnSpan="2" x:Name="ChooseAttachment" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch" />
        </Grid>

        <ContentControl Grid.RowSpan="2" Grid.ColumnSpan="2" x:Name="ImageEditor"
                        VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                        VerticalContentAlignment="Stretch" HorizontalContentAlignment="Stretch"/>
        
        <ContentControl Grid.RowSpan="2" Grid.ColumnSpan="2" x:Name="MultiImageEditor"
                        VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                        VerticalContentAlignment="Stretch" HorizontalContentAlignment="Stretch"/>

        <!--For performance reason with Pan&Zoom set ImageViewerView on Top of main Grid-->
        <ContentControl Grid.RowSpan="2" Grid.ColumnSpan="2" x:Name="ImageViewer"
                        VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                        VerticalContentAlignment="Stretch" HorizontalContentAlignment="Stretch"/>
        <ContentControl Grid.RowSpan="2" Grid.ColumnSpan="2" x:Name="AnimatedImageViewer"
                        VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                        VerticalContentAlignment="Stretch" HorizontalContentAlignment="Stretch"
                        Visibility="{Binding AnimatedImageViewer.IsOpen, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Collapsed}"/>
        
    </Grid>
</views:TelegramViewBase>